!function(g,l,f){"use strict";var W="ht",H=g[W],U=H.Default,A=U.def,E=U.getInternal();H.HistoryManager=function(J){this._histories=[],this.setDataModel(J)},A(H.HistoryManager,l,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},ignoreDataModelPropertyMap:{},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var z=this;z._betweenTransaction++,1===z._betweenTransaction&&(z._transactionHistories={})}},endTransaction:function(){if(!this._disabled){var A=this,I=A._histories;if(A._betweenTransaction>0&&A._betweenTransaction--,0===A._betweenTransaction){if(A._transactionHistories){var J=[];for(var u in A._transactionHistories)J.push(A._transactionHistories[u]);J.length&&(I=I.slice(0,A._historyIndex+1),I.push(J),I.length>A._maxHistoryCount&&(I=I.slice(I.length-A._maxHistoryCount)),A.setHistories(I),A.setHistoryIndex(I.length-1,!0))}delete A._transactionHistories}}},setDataModel:function(K){var N=this,$=N._dataModel;$!==K&&($&&(delete $._historyManager,$.ump(N.handleDataModelPropertyChange,N),$.umm(N.$5p,N),$.umd(N.$6p,N),$.removeHierarchyChangeListener(N.handleHierarchyChange,N),$.removeIndexChangeListener(N.handleIndexChange,N)),N._dataModel=K,K&&(K._historyManager=N,K.mp(N.handleDataModelPropertyChange,N),K.mm(N.$5p,N),K.md(N.$6p,N),K.addHierarchyChangeListener(N.handleHierarchyChange,N),K.addIndexChangeListener(N.handleIndexChange,N)),N.fp("dataModel",$,K),N.clear())},setHistoryIndex:function($,U){var z=this,a=z._historyIndex,e=z._histories.length;if(-1>$?$=-1:$>=e&&($=e-1),a!==$){if(!U){var s=$-a;s>0?z.$2p(s):0>s&&z.$1p(-s)}z._historyIndex=$,z.fp("historyIndex",a,$),z.dataModel&&z.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(w){var X=this,s=X._histories,O=X._maxHistoryCount;(!w||0>=w)&&(w=10),O!==w&&(X._maxHistoryCount=w,X.fp("maxHistoryCount",O,w),s.length>w&&X.clear())},cloneValue:function(k){return H.Default.clone(k)},isPropertyUndoable:function(c){return c&&!this.ignoredPropertyMap[c]},isIndexUndoable:function(){return!1},isDataModelPropertyUndoable:function(K){return K&&!this.ignoreDataModelPropertyMap[K]},$5p:function(R){this.handleChange(R,R.kind)},$6p:function(n){this.handleChange(n,"property")},handleHierarchyChange:function(B){this.handleChange(B,"hierarchy")},handleIndexChange:function(H){this.handleChange(H,"index")},handleDataModelPropertyChange:function(E){this.handleChange(E,"dataModelProperty")},toChildrenInfo:function(r){var k={};return k.data=r,k.children=[],r.eachChild(function(U){k.children.push(this.toChildrenInfo(U))},this),k},restoreChildren:function(p){var U=p.data;p.children.forEach(function(B){var D=B.data;D.getParent()!==U&&U.addChild(D),this._dataModel.contains(D)||this._dataModel.add(D),this.restoreChildren(B)},this)},handleChange:function(P,j){var K=this;if(!(K._disabled||K._isUndoRedoing||U.loadingRefGraph)){var E,D=(K._histories,P.data),S=P.property;if(!D||!(D._refGraph||D instanceof H.RefGraph)){if("property"===j)K.isPropertyUndoable(S,D)&&(E={kind:j,data:D,property:S,oldValue:K.cloneValue(P.oldValue,D,S),newValue:K.cloneValue(P.newValue,D,S),event:P});else if("hierarchy"===j||"index"===j&&K.isIndexUndoable(P))E={kind:j,data:D,oldIndex:P.oldIndex,newIndex:P.newIndex,event:P};else if("clear"===j)E={kind:j,json:P.json,event:P};else if("add"===j){if(E={kind:j,data:D,event:P,childrenInfo:this.toChildrenInfo(D),parent:D.getParent()},E.parent){var y=K._dataModel.getSiblings(D);E.siblingsIndex=y.indexOf(D)}D instanceof H.Node&&(E.host=D.getHost(),E.attaches=D.getAttaches()?D.getAttaches().toArray():f),D instanceof H.Edge&&(E.source=D.getSource(),E.target=D.getTarget())}else"remove"===j?E={kind:j,data:D,event:P}:"dataModelProperty"===j&&K.isDataModelPropertyUndoable(S,D)&&(E={kind:j,property:S,oldValue:K.cloneValue(P.oldValue,D,S),newValue:K.cloneValue(P.newValue,D,S),event:P});K.addHistory(E)}}},addHistory:function(k){var o=this;if(k)if(o._betweenTransaction){var t=(k.data?k.data._id:0)+"_"+k.kind+"_"+k.property;if("property"===k.kind||"dataModelProperty"===k.kind){var z=o._transactionHistories[t];z&&(k.oldValue=z.oldValue)}o._transactionHistories[t]=k}else{var u=o._histories;u=u.slice(0,o._historyIndex+1),u.push([k]),u.length>o._maxHistoryCount&&(u=u.slice(u.length-o._maxHistoryCount)),o.setHistories(u),o.setHistoryIndex(u.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(u){(!u||0>=u)&&(u=1),this.setHistoryIndex(this._historyIndex-u)},$1p:function(j){if(this.canUndo()){var b,A=this,C=A._dataModel,i=A._histories,d=A._historyIndex,g=0;for(A._isUndoRedoing=!0,U.setIsolating(!0);j>0;){if(d>=0&&d<i.length){g++,b=i[d],d--;for(var r=b.length-1;r>=0;r--){var w=b[r],H=w.kind,K=w.data,c=w.property,Q=w.event,P=this.cloneValue(w.oldValue,K,c);if(w.undo)w.undo();else if("add"===H)C.remove(K,{keepChildren:!0});else if("remove"===H)C.contains(K)||C.add(K,Q.rootsIndex,Q.datasIndex);else if("clear"===H)C.deserialize(U.clone(w.json));else if("property"===H)if("parent"===c)P?P.addChild(K,Q.oldIndex):(K.setParent(P),Q.oldIndex>=0&&C.moveTo(K,Q.oldIndex));else{var h=null;0===c.indexOf("a:")?(h="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(h="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(h="field",c=c.replace("f:","")),E.setPropertyValue(K,h,c,P)}else if("dataModelProperty"===H){var h=null;0===c.indexOf("a:")?(h="attr",c=c.replace("a:","")):0===c.indexOf("s:")?(h="style",c=c.replace("s:","")):0===c.indexOf("f:")&&(h="field",c=c.replace("f:","")),E.setPropertyValue(C,h,c,P)}else"hierarchy"===H?C.moveTo(K,w.oldIndex):"index"===H&&C.moveToIndex(K,w.oldIndex)}}j--}U.setIsolating(!1),delete A._isUndoRedoing,A.afterUndo(g)}},afterUndo:function(){},redo:function(i){(!i||0>=i)&&(i=1),this.setHistoryIndex(this._historyIndex+i)},$2p:function($){if(this.canRedo()){var i,n=this,P=n._dataModel,F=n._histories,D=n._historyIndex,r=0;for(n._isUndoRedoing=!0,U.setIsolating(!0);$>0;){if(D>=-1&&D<F.length-1){r++,D++,i=F[D];for(var Q=0;Q<i.length;Q++){var M=i[Q],X=M.kind,W=M.data,t=M.property,J=M.event,R=this.cloneValue(M.newValue,W,t);if(M.redo)M.redo();else if("add"===X)M.parent&&!W.getParent()&&M.parent.addChild(W,M.siblingsIndex),P.contains(W)||P.add(W,J.rootsIndex,J.datasIndex),this.restoreChildren(M.childrenInfo),W instanceof H.Node&&(W.setHost(M.host),M.attaches&&M.attaches.forEach(function(m){m.setHost(W)})),W instanceof H.Edge&&(W.setSource(M.source),W.setTarget(M.target));else if("remove"===X)P.remove(W);else if("clear"===X)P.clear();else if("property"===X)if("parent"===t)R?R.addChild(W,J.newIndex):(W.setParent(R),J.newIndex>=0&&P.moveTo(W,J.newIndex));else{var e=null;0===t.indexOf("a:")?(e="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(e="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(e="field",t=t.replace("f:","")),E.setPropertyValue(W,e,t,R)}else if("dataModelProperty"===X){var e=null;0===t.indexOf("a:")?(e="attr",t=t.replace("a:","")):0===t.indexOf("s:")?(e="style",t=t.replace("s:","")):0===t.indexOf("f:")&&(e="field",t=t.replace("f:","")),E.setPropertyValue(P,e,t,R)}else"hierarchy"===X?P.moveTo(W,M.newIndex):"index"===X&&P.moveToIndex(W,M.newIndex)}}$--}U.setIsolating(!1),delete n._isUndoRedoing,this.afterRedo(r)}},afterRedo:function(){},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);